{% extends 'admin_base.html' %} {% block content %}
  {% load form_filters %} {% load custom_filters %}
  <!DOCTYPE html>
  <html>
    <head>
      <style>
        input[type='checkbox'][name$='-DELETE'],
        label[for$='-DELETE'] {
          display: none;
        }
        
        .form-container {
          margin-top: 25px;
        }
        
        .form-group {
          margin-bottom: 15px;
        }
        
        .form-group label {
          display: block;
          margin-bottom: 5px;
        }
        
        .form-actions {
          margin-top: 20px;
          text-align: right;
        }
        
        .btn {
          margin-right: 10px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        
        th,
        td {
          border: 1px solid #dddddd;
          text-align: left;
          padding: 8px;
        }
        
        th {
          background-color: #f2f2f2;
        }
        
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 40px;
          height: 20px;
        }
        
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: 0.4s;
          border-radius: 34px;
        }
        
        .slider:before {
          position: absolute;
          content: '';
          height: 16px;
          width: 16px;
          left: 2px;
          bottom: 2px;
          background-color: white;
          transition: 0.4s;
          border-radius: 50%;
        }
        
        input:checked + .slider {
          background-color: #4caf50;
        }
        
        input:checked + .slider:before {
          transform: translateX(20px);
        }
        .custom-select {
          display: block;
          width: 100%;
          height: calc(2.25rem + 2px);
          padding: 0.375rem 1.75rem 0.375rem 0.75rem;
          font-size: 1rem;
          line-height: 1.5;
          color: #495057;
          background-color: #fff;
          background-clip: padding-box;
          border: 1px solid #ced4da;
          border-radius: 0.25rem;
          transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .custom-select:focus {
          border-color: #80bdff;
          outline: 0;
          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .form-group {
          margin-bottom: 1.5rem;
        }
        
        .form-label {
          font-weight: bold;
        }
      </style>
      <title>Add New Store Item</title>
      <!-- Your existing styles remain the same -->
    </head>

    <body>
      <div class="main-content">
        <h1>Add New Store Item</h1>
        <div class="form-container">
          <form method="post" enctype="multipart/form-data" id="store-item-form">
            {% csrf_token %} {{ store_item_form.as_p }}

            <!-- Variation formset management form -->
            {{ variation_formset.management_form }}

            <div id="variation-container">
              <!-- Initial variation form -->
              {% for variation_form in variation_formset %}
                <!-- Modify this section in add_store_item.html -->
                <div class="variation-form" data-index="0">
                  <div class="variation-fields">
                    {{ variation_form.as_p }} {% with choices_formset=choices_formsets|first %}
                      {{ choices_formset.management_form }}
                      <table>
                        <thead>
                          <tr>
                            <th>Choice Name</th>
                            <th>Price Increment</th>
                            <th>Actions</th>
                            <!-- Added Actions column -->
                          </tr>
                        </thead>
                        <tbody class="choices-container">
                          {% for choice_form in choices_formset %}
                            <tr class="choice-row">
                              <td>{{ choice_form.name }}</td>
                              <td>{{ choice_form.price_increment }}</td>
                              <td>
                                <button type="button" class="btn btn-danger btn-sm remove-choice">Remove</button>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                      <a href="#" class="add-choice-link" data-variation-index="0">+ Add Choice</a>
                      <!-- Added Add Choice link -->
                    {% endwith %}
                  </div>
                </div>
              {% endfor %}
            </div>

            <button type="button" id="add-variation" class="btn btn-outline">Add Variation</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </form>
        </div>
      </div>

      <script>
        let variationCounter = 1 // Start from 1 since we have the initial form
        
        // Add Variation button handler
        document.getElementById('add-variation').addEventListener('click', function () {
          const nextIndex = variationCounter++
        
          fetch(`{% url 'dashboard:add_variation_with_choices' %}?form_index=${nextIndex}`)
            .then((response) => response.text())
            .then((html) => {
              document.getElementById('variation-container').insertAdjacentHTML('beforeend', html)
              updateFormIndexes()
            })
        })
        
        // Add Choice and Remove Choice handlers
        document.addEventListener('click', function (e) {
          // Handle Add Choice
          if (e.target.classList.contains('add-choice-link')) {
            e.preventDefault()
            const variationIndex = e.target.dataset.variationIndex
            const choicesContainer = e.target.closest('.variation-fields').querySelector('.choices-container')
            const managementForm = e.target.closest('.variation-fields').querySelector('[name$="-TOTAL_FORMS"]')
            const nextIndex = parseInt(managementForm.value)
        
            fetch(`{% url 'dashboard:add_choice_field' %}?variation_index=${variationIndex}&choice_index=${nextIndex}`)
              .then((response) => response.text())
              .then((html) => {
                choicesContainer.insertAdjacentHTML('beforeend', html)
                managementForm.value = nextIndex + 1
              })
          }
        
          // Handle Remove Choice
          if (e.target.classList.contains('remove-choice')) {
            const row = e.target.closest('.choice-row')
            const container = row.closest('.choices-container')
            const managementForm = container.closest('.variation-fields').querySelector('[name$="-TOTAL_FORMS"]')
        
            row.remove()
            managementForm.value = parseInt(managementForm.value) - 1
        
            // Update remaining choices' indices
            container.querySelectorAll('.choice-row').forEach((row, index) => {
              row.querySelectorAll('input').forEach((input) => {
                const oldName = input.name
                const newName = oldName.replace(/\d+/, index)
                input.name = newName
                if (input.id) {
                  input.id = input.id.replace(/\d+/, index)
                }
              })
            })
          }
        })
        
        function updateFormIndexes() {
          // Update variation management form
          const totalFormsInput = document.querySelector('[name="variation-TOTAL_FORMS"]')
          if (totalFormsInput) {
            totalFormsInput.value = variationCounter
          }
        
          // Update each variation form's indices
          document.querySelectorAll('.variation-form').forEach((form, index) => {
            // Update variation fields
            form.querySelectorAll('[name*="variation-"]').forEach((input) => {
              const oldName = input.name
              const newName = oldName.replace(/variation-\d+/, `variation-${index}`)
              input.name = newName
              if (input.id) {
                input.id = input.id.replace(/variation-\d+/, `variation-${index}`)
              }
            })
        
            // Update choices fields
            const choicesContainer = form.querySelector('.choices-container')
            if (choicesContainer) {
              choicesContainer.querySelectorAll('.choice-row').forEach((row, choiceIndex) => {
                row.querySelectorAll('input').forEach((input) => {
                  const oldName = input.name
                  const newName = oldName.replace(/choices_\d+-\d+/, `choices_${index}-${choiceIndex}`)
                  input.name = newName
                  if (input.id) {
                    input.id = input.id.replace(/choices_\d+-\d+/, `choices_${index}-${choiceIndex}`)
                  }
                })
              })
            }
          })
        }
        
        // Add form submission handler for debugging
        document.getElementById('store-item-form').addEventListener('submit', function (e) {
          // Log form data before submission
          const formData = new FormData(this)
          for (let pair of formData.entries()) {
            console.log(pair[0], pair[1])
          }
        })
      </script>
    </body>
  </html>
{% endblock %}
